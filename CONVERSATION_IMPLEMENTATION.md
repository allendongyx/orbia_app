# KOL 订单会话功能实现说明

## 概述

已成功在 KOL 订单详情页面（`/kol/orders/[id]`）接入会话功能，允许用户和 KOL 实时沟通。

## 实现的功能

### 1. **消息展示**
- ✅ 消息列表实时展示，支持文本、图片、文件等多种消息类型
- ✅ 当前用户的消息显示在右侧（蓝色气泡）
- ✅ 对方的消息显示在左侧（灰色气泡）
- ✅ 每条消息显示发送者头像和时间
- ✅ 系统消息居中显示

### 2. **消息发送**
- ✅ 文本消息发送（支持换行和多行文本）
- ✅ 图片上传并发送
- ✅ 文件上传并发送
- ✅ 发送状态反馈（加载动画、成功/失败提示）

### 3. **历史消息加载**
- ✅ 首次加载最新的 20 条消息
- ✅ 向上滚动自动加载更多历史消息
- ✅ "加载更多"按钮支持手动触发
- ✅ 保持滚动位置不变（加载历史消息时）

### 4. **实时更新**
- ✅ 每 5 秒自动轮询获取新消息
- ✅ 新消息到达时自动滚动到底部
- ✅ 发送消息后立即刷新列表

### 5. **用户体验优化**
- ✅ 自动标记消息已读
- ✅ 上传进度提示
- ✅ 文件类型校验
- ✅ 空状态提示（无会话、无消息）
- ✅ 响应式布局（左右分栏）

## 技术实现

### API 层（`lib/api/conversation.ts`）

```typescript
// 主要接口
- getConversations(): 获取会话列表
- getMessages(): 获取消息列表（支持翻页）
- sendMessage(): 发送消息
- markRead(): 标记已读
```

### 页面实现（`app/kol/orders/[id]/page.tsx`）

#### 关键功能点：

1. **会话加载**
```typescript
// 通过订单 ID 从会话列表中查找对应会话
const loadConversation = async () => {
  const result = await getConversations({ type: 'kol_order' });
  const matchedConversation = result.conversations.find(
    conv => conv.related_order_id === orderId
  );
  return matchedConversation;
};
```

2. **消息分页加载**
```typescript
// 首次加载
await loadMessages(conversationId);

// 加载更多（向上翻页）
const oldestMessage = messages[0];
await loadMessages(conversationId, oldestMessage.created_at, true);
```

3. **文件上传**
```typescript
// 使用 R2 上传文件
const uploadUrl = await uploadToR2(file);

// 发送文件消息
await sendMessage({
  conversation_id: conversationId,
  message_type: 'image', // 或 'file'
  content: uploadUrl,
  file_name: file.name,
  file_size: file.size,
  file_type: file.type,
});
```

4. **轮询机制**
```typescript
// 每 5 秒轮询一次
useEffect(() => {
  const interval = setInterval(pollNewMessages, 5000);
  return () => clearInterval(interval);
}, [conversation, messages]);
```

## 消息类型支持

| 类型 | 描述 | 展示方式 |
|------|------|----------|
| `text` | 文本消息 | 普通文本气泡 |
| `image` | 图片消息 | 图片预览 + 点击放大 |
| `file` | 文件消息 | 文件图标 + 文件名 + 大小 + 下载按钮 |
| `video` | 视频消息 | 同文件消息 |
| `audio` | 音频消息 | 同文件消息 |
| `system` | 系统消息 | 居中显示的提示消息 |

## 页面布局

```
┌─────────────────────────────────────────────────────────┐
│ ← 返回           订单详情         [订单状态]            │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────────────────┐  ┌───────────────────┐   │
│  │    与 XXX 的对话          │  │   KOL 信息        │   │
│  │                           │  ├───────────────────┤   │
│  │  [加载更多消息]           │  │   订单详情        │   │
│  │                           │  ├───────────────────┤   │
│  │  👤 对方消息              │  │   订单金额        │   │
│  │                           │  ├───────────────────┤   │
│  │        我的消息 👤        │  │   时间信息        │   │
│  │                           │  ├───────────────────┤   │
│  │  👤 对方图片              │  │   订单进度        │   │
│  │                           │  └───────────────────┘   │
│  ├───────────────────────────┤                          │
│  │ 📎 🖼️ [输入框...] [发送] │                          │
│  └───────────────────────────┘                          │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## 使用流程

### 用户视角
1. 创建 KOL 订单
2. 支付订单
3. KOL 确认订单 → **系统自动创建会话**
4. 在订单详情页面与 KOL 沟通
5. 完成订单

### 技术流程
1. 页面加载时：
   - 加载订单详情
   - 查找对应会话
   - 加载最新消息（20条）
   - 标记消息已读
   - 启动轮询

2. 用户操作：
   - 输入文本 → 发送 → 添加到列表
   - 选择图片 → 上传 → 发送 → 添加到列表
   - 选择文件 → 上传 → 发送 → 添加到列表
   - 向上滚动 → 加载更多历史消息

3. 后台轮询：
   - 每 5 秒获取最新消息
   - 发现新消息 → 添加到列表 → 滚动到底部

## 注意事项

### 1. 会话创建时机
- 会话在订单状态变为 `confirmed` 时自动创建
- 在此之前，页面会显示"会话尚未创建"提示

### 2. 性能优化
- 消息默认加载 20 条，避免一次加载过多
- 使用 `useCallback` 和 `useRef` 避免不必要的重渲染
- 轮询间隔 5 秒，平衡实时性和服务器压力

### 3. 文件上传
- 支持的文件类型由 `lib/r2-upload.ts` 定义
- 图片最大 10MB，文档最大 50MB，视频最大 100MB
- 上传失败会显示错误提示

### 4. 滚动行为
- 首次加载自动滚动到底部
- 新消息到达自动滚动到底部
- 加载历史消息保持当前位置

## 待优化项

1. **消息状态**
   - 显示消息发送状态（发送中、已送达、已读）
   - 失败消息重发功能

2. **富文本支持**
   - 表情选择器
   - Markdown 支持
   - @提及功能

3. **媒体预览**
   - 视频播放器
   - 音频播放器
   - 图片画廊

4. **通知功能**
   - 浏览器通知
   - 未读消息提示音
   - 标题栏闪烁提示

5. **搜索功能**
   - 消息内容搜索
   - 文件筛选

## 相关文件

```
lib/api/
  └── conversation.ts       # 会话 API 接口定义

app/kol/orders/[id]/
  └── page.tsx             # 订单详情页面（含会话功能）

lib/
  └── r2-upload.ts         # 文件上传工具
```

## API 文档参考

完整的会话 API 文档请参考用户提供的文档，主要接口包括：

- `POST /api/v1/conversation/send_message` - 发送消息
- `POST /api/v1/conversation/get_messages` - 获取消息列表
- `POST /api/v1/conversation/get_conversations` - 获取会话列表
- `POST /api/v1/conversation/mark_read` - 标记已读

## 测试建议

1. **基础功能测试**
   - 发送文本消息
   - 上传图片
   - 上传文件
   - 滚动加载历史消息

2. **边界情况测试**
   - 订单未确认时的状态
   - 网络断开时的重连
   - 大文件上传
   - 并发消息发送

3. **用户体验测试**
   - 消息发送延迟
   - 滚动流畅度
   - 轮询性能影响
   - 移动端适配

## 总结

KOL 订单会话功能已完整实现并集成到订单详情页面，支持文本、图片、文件等多种消息类型，提供了良好的实时沟通体验。代码结构清晰，易于维护和扩展。

